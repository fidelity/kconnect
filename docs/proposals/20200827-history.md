---
title: kconnect history
authors:
  - "@richardcase"
reviewers:
  - "@richardcase"
creation-date: 2020-08-27
last-updated: 2020-08-27
status: provisional
see-also:
    - "/docs/proposals/20200607-initial-design.md"
replaces:
superseded-by:
---

# kconnect - history

## Summary

This proposal includes a proposal for introducing **history** of connections into kconnect

## Motivation

To aid the utility of kconnect a history of connections will be kept. This history can then be used at a later date to generate the kubeconfig quicker and with less information. This is to make the tool more useful to its users.

### Goals

* Demonstrate how `kconnect ls` will be used
* Demonstrate how `kconnect use` will be updated
* Aid refinement of the initial design

### Non-goals/Future Work

*

## Proposal/Design

A new `ls` command will be introduced which will show the history of the connections you have made to clusters. You can see further details of a selected history item (i.e. its flags). Then based on a history entry you can re-generate a kubeconfig using `kconnect use` without having to re-enter all the flag values. The only values that aren't saved are values for flags that are deemed sensitive such as `--password`.

The following sections summarise the proposal for implementing the history in kconnect.

### History file

#### Location & format

Its proposed the history of connections be held in the following file: `$HOME/.kconnect/history`. The format of the file is undecided but a textual format such as YAML will likely be used initially. We will consider binary formats as well.

#### When will history be stored

Everytime `kconnect use` is invoked and a kubeconfig file is created a history item will be created.

#### Data stored

The data stored in the history file will be an entry for each successful `kconnect use` invocation. Each entry will store the following:

* Disovery provider used (i.e. eks)
* Identity provider used (i.e. saml)
* Date/time (ISO 8601 format) of when the entry was added
* Unique discovery provider specific identifer for that cluster. For example, with the EKS provider we might stote the AWs account ID and EKS cluster name. This identifier must be unique and stable.
* Alias - optional name that can be used
* Flags and flag values - except flags deemded sensitive
* Location of the kubeconfig file that was written to

As an example (if we where using YAML as the format):

```yaml
-
provider: eks
identity: saml
id: MTIzNDU2Nzg5L215Y2x1c3RlcjE  # base 64 url safe encoding of 123456789/mycluster1
datetime: 2020-08-27T16:06:08.180856
flags:
    username: bob@someone.com
    idp-provider: GoogleApps
    idp-endpoint: https://accounts.google.com/o/saml2/initsso?idpid=
    profile: g-saml
    role: arn:aws:iam::123456789:role/TestAccess
config: ~/.kube/config
alias: dev-eks-cluster
```

### User Experience

#### Showing the history

First showing help for the `ls` command

```bash
kconnect ls -h

shows the history of the connections you have made using kconnect

Usage:

kconnect ls [FLAGS] e.g ./kconnect ls --provider eks

flags:

-p  --provider         [optional]    used to filter history items based on a specific cluster provider (e.g. eks)
-i  --identity         [optional]    used to filter history items based on a specific identity provider (e.g. saml)
    --id               [optional]    used to filter history items for a cluster with the specified id
-a  --alias            [optional]    used to filter history items for a cluster with a specific alias. It supports wildcards.
-f  --flag             [optional]    used to filter history items based on a flag and its value
-k  --kubeconfig       [optional]    used to filter history items that where written to the specified kubeconfig
-o  --output           [optional]    used to specify the output format of the history. Defaults to yaml. Options are [yaml,json,table]

Example usage:

    kconnect ls --flag username=bob@somewhere.com

```

When using the command to filter connections made to EKS you might do the following:

```bash
kconnect ls --provider eks -o table

| ID                        | Providers | Identity | Alias       | Config     | Flags                      |
|===========================|===========|==========|=============|============|============================|
|MTIzNDU2Nzg5L215Y2x1c3RlcjE| EKS       | SAML     | dev-eks     | (default)  | username=bob@somewhere.com |
|                           |           |          |             |            | idp-provider=GoogleApps    |
|---------------------------|-----------|----------|-------------|------------|----------------------------|

```


#### Using the history

Using a history item will require changes to the `use` command. Its proposed that the `use` command be changed to support the following ux

```bash
# One of the following 2 commands would be used
kconnect use history --id MTIzNDU2Nzg5L215Y2x1c3RlcjE
kconnect use history --alias dev-eks

Using history item MTIzNDU2Nzg5L215Y2x1c3RlcjE (eks/saml)

Enter your password: *******************

saving your settings to $HOME/.kconnect/config.yaml

you can run kubectl commands now!

```

The above UX implies that a new provider be created called `history`. This may not fit the current code and will need to be investigated at implementation time. If its not possible then a new command will be introduced:

```bash
kconnect use-history --id MTIzNDU2Nzg5L215Y2x1c3RlcjE
kconnect use-history --alias dev-eks
```

### Changes to `kconnect use`

To support the alias functionality we will need to make some changes to the `use` command to allow the user to optionally enter an alias.Its proposed that an additional flag be included `-a/--alias` that the user can specify when running the command. If the flag isn't specified and we are running in interactive mode then the user will be asked to enter an alias.

If an alias is specified via flag or user entry then the history will be checked to see if the alias has already been used. If it has already been used then an error will be returned to the user.

### Changes to providers

The existing providers will need to be changed so that they return a unique identifier for a cluster than is accessible via that provider. As an example a EKS cluster in AWS can be uniquely identied via its ARN or via a account number/cluster name combination. It would be up to the provider to return this provider unique identifier in the [Cluster.ID](https://github.com/fidelity/kconnect/blob/main/pkg/provider/types.go#L85) field.

### Additional Details

We could also consider adding a new command called `alias` that has an number of subcommands to allow the user to maintain the aliases. For example:

```bash
# Add an alias to a history item
kconnect alias add --id MTIzNDU2Nzg5L215Y2x1c3RlcjE --alias dev-eks

# Delete an alias from a history item
kconnect alias rm --id MTIzNDU2Nzg5L215Y2x1c3RlcjE

# List all the aliases an their history ids
kconnect alias ls
